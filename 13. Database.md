## ðŸ’¾ Chapter 13: Working with Databases (SQL/NoSQL)

Go interacts with databases through its standard library and specialized external packages. This chapter focuses on the universal `database/sql` package for SQL databases.

### 1. The `database/sql` Package

The standard library provides the **`database/sql`** package, which defines a generic interface for working with databases. To use a specific database (like PostgreSQL, MySQL, or SQLite), you must also import a **database driver** package.

#### A. Required Driver

You need to import a driver, often using the blank identifier (`_`) because you only need the driver's initialization logic, not its exported functions directly.

Go

```
import (
    "database/sql"
    _ "github.com/lib/pq" // PostgreSQL driver (example)
    // _ "github.com/go-sql-driver/mysql" // MySQL driver (example)
)
```

### 2. Establishing a Connection

The `sql.Open` function establishes the connection pool, but it **does not** immediately open a database connection. It only validates the arguments. You must check the connection explicitly with `db.Ping()`.

#### Example: Opening and Pinging

Go

```
package main

import (
    "database/sql"
    "fmt"
    "log"
    _ "github.com/lib/pq" // Replace with your driver
)

func main() {
    // Replace the connection string with your database credentials
    connStr := "user=go_user dbname=go_db sslmode=disable password=secret"
    
    // 1. Open the database connection pool
    db, err := sql.Open("postgres", connStr)
    if err != nil {
        log.Fatal(err)
    }
    // 2. Always defer closing the pool!
    defer db.Close() 

    // 3. Ping to verify connection is active
    err = db.Ping()
    if err != nil {
        log.Fatal("Could not ping database:", err)
    }
    fmt.Println("Successfully connected to the database!")
}
```

### 3. Executing Commands (`Exec` vs. `Query`)

There are two primary ways to interact with the database:

|**Function**|**Use Case**|**Returns**|**Example**|
|---|---|---|---|
|**`db.Exec`**|For commands that **do not return rows** (INSERT, UPDATE, DELETE, CREATE).|`sql.Result` (rows affected, last insert ID) and `error`.|`db.Exec("INSERT INTO users ...")`|
|**`db.Query`**|For commands that **return multiple rows** (SELECT).|`*sql.Rows` and `error`.|`db.Query("SELECT name FROM users")`|
|**`db.QueryRow`**|For commands expected to **return a single row** (SELECT by ID).|`*sql.Row` (no error returned immediately).|`db.QueryRow("SELECT name ...")`|

#### Example: Querying Data

Go

```
// Assume a struct to hold the result
type User struct {
    ID   int
    Name string
}

func getUsers(db *sql.DB) {
    // Query returns *sql.Rows
    rows, err := db.Query("SELECT id, name FROM users")
    if err != nil {
        log.Fatal(err)
    }
    // Must close rows when finished!
    defer rows.Close() 

    // Iterate through the results
    for rows.Next() {
        var u User
        // Scan copies the columns from the current row into variables
        if err := rows.Scan(&u.ID, &u.Name); err != nil {
            log.Fatal(err)
        }
        fmt.Printf("User: ID=%d, Name=%s\n", u.ID, u.Name)
    }

    // Check for errors encountered during iteration
    if err := rows.Err(); err != nil {
        log.Fatal(err)
    }
}
```

**ðŸ”¥ Important:** Always use **prepared statements** (placeholders like `$1`, `?`) instead of string formatting to prevent **SQL Injection** attacks.

### 4. Transactions

For operations that must succeed or fail as a unit (e.g., transferring money), use transactions.

Go

```
tx, err := db.Begin()
if err != nil { log.Fatal(err) }

_, err = tx.Exec("UPDATE accounts SET balance = balance - 10 WHERE id = 1")
if err != nil {
    tx.Rollback() // Rollback on error
    log.Fatal(err)
}

_, err = tx.Exec("UPDATE accounts SET balance = balance + 10 WHERE id = 2")
if err != nil {
    tx.Rollback() // Rollback on error
    log.Fatal(err)
}

err = tx.Commit() // Commit if all operations succeeded
if err != nil {
    log.Fatal(err)
}
```

---

### ðŸ”— Reference

- **Go Documentation - `database/sql`:** [https://go.dev/pkg/database/sql/](https://go.dev/pkg/database/sql/)
    
- **Go Wiki - Database Access:** Detailed guide on drivers and best practices: [https://github.com/golang/go/wiki/SQLDrivers](https://github.com/golang/go/wiki/SQLDrivers)